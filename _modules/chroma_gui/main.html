

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>chroma_gui.main &mdash; omc3-gui 0.0.26 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=178c8cd6" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=6a9d8632"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/omc_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Main</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../main/chroma_gui.html">Chroma-GUI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../main/chroma_gui.html#main">Main</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/chromaticity.html">Chromaticity</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/chromaticity.html#chromaticity-module">Chromaticity Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/chromaticity.html#chromaticity-functions">Chromaticity Functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/cleaning.html">Cleaning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/cleaning.html#cleaning-module">Cleaning Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/cleaning.html#clean">Clean</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/cleaning.html#constants">Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/cleaning.html#plateau-finder">Plateau Finder</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/corrections.html">Corrections</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/corrections.html#corrections-module">Corrections Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/corrections.html#response-matrix">Response Matrix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/plotting.html">Plotting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/plotting.html#plotting-module">Plotting Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/plotting.html#functions">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/plotting.html#widget">Widget</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/timber.html">Timber</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/timber.html#timber-module">Timber Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/timber.html#constants">Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/timber.html#extract">Extract</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bibliography</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">omc3-gui</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">chroma_gui.main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  
  
           <div itemprop="articleBody">
             
  <h1>Source code for chroma_gui.main</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">Main</span>
<span class="sd">----</span>

<span class="sd">Main module for the chroma-gui.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fields</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONDecodeError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyperclip</span>

<span class="c1"># PyQt libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qtawesome</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">qta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tfs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtTest</span><span class="p">,</span> <span class="n">uic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">QAbstractTableModel</span><span class="p">,</span>
    <span class="n">QDateTime</span><span class="p">,</span>
    <span class="n">QEvent</span><span class="p">,</span>
    <span class="n">QModelIndex</span><span class="p">,</span>
    <span class="n">QSize</span><span class="p">,</span>
    <span class="n">Qt</span><span class="p">,</span>
    <span class="n">QThread</span><span class="p">,</span>
    <span class="n">pyqtSignal</span><span class="p">,</span>
    <span class="n">pyqtSlot</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtGui</span><span class="w"> </span><span class="kn">import</span> <span class="n">QFontMetrics</span><span class="p">,</span> <span class="n">QPalette</span><span class="p">,</span> <span class="n">QStandardItem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">QApplication</span><span class="p">,</span>
    <span class="n">QComboBox</span><span class="p">,</span>
    <span class="n">QDialog</span><span class="p">,</span>
    <span class="n">QFileDialog</span><span class="p">,</span>
    <span class="n">QHBoxLayout</span><span class="p">,</span>
    <span class="n">QHeaderView</span><span class="p">,</span>
    <span class="n">QLabel</span><span class="p">,</span>
    <span class="n">QLayout</span><span class="p">,</span>
    <span class="n">QListWidgetItem</span><span class="p">,</span>
    <span class="n">QMainWindow</span><span class="p">,</span>
    <span class="n">QMessageBox</span><span class="p">,</span>
    <span class="n">QSizePolicy</span><span class="p">,</span>
    <span class="n">QStyledItemDelegate</span><span class="p">,</span>
    <span class="n">QTableView</span><span class="p">,</span>
    <span class="n">qApp</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">chroma_gui.cleaning.constants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cleaning_constants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">chroma_gui.timber</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">timber</span>

<span class="c1"># Chroma-GUI specific libraries</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chroma_gui</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">chroma_gui_version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chroma_gui.chromaticity</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">construct_chroma_tfs</span><span class="p">,</span>
    <span class="n">get_chromaticity</span><span class="p">,</span>
    <span class="n">get_chromaticity_df_with_notation</span><span class="p">,</span>
    <span class="n">get_chromaticity_formula</span><span class="p">,</span>
    <span class="n">get_maximum_chromaticity</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chroma_gui.cleaning</span><span class="w"> </span><span class="kn">import</span> <span class="n">clean</span><span class="p">,</span> <span class="n">plateau</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chroma_gui.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">CHROMA_COEFFS</span><span class="p">,</span> <span class="n">CHROMA_FILE</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="n">RESPONSE_MATRICES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chroma_gui.corrections</span><span class="w"> </span><span class="kn">import</span> <span class="n">response_matrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chroma_gui.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">plot_chromaticity</span><span class="p">,</span>
    <span class="n">plot_dpp</span><span class="p">,</span>
    <span class="n">plot_freq</span><span class="p">,</span>
    <span class="n">plot_timber</span><span class="p">,</span>
    <span class="n">save_chromaticity_plot</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chroma_gui.plotting.widget</span><span class="w"> </span><span class="kn">import</span> <span class="n">MplWidget</span><span class="p">,</span> <span class="n">mathTex_to_QPixmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chroma_gui.timber</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_variables_names_from_csv</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;chroma_GUI&quot;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="n">RESOURCES</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;resources&quot;</span>

<span class="c1"># Load the different UI windows</span>
<span class="n">new_measurement_class</span> <span class="o">=</span> <span class="n">uic</span><span class="o">.</span><span class="n">loadUiType</span><span class="p">(</span><span class="n">RESOURCES</span> <span class="o">/</span> <span class="s2">&quot;ui_components&quot;</span> <span class="o">/</span> <span class="s2">&quot;new_measurement.ui&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">main_window_class</span> <span class="o">=</span> <span class="n">uic</span><span class="o">.</span><span class="n">loadUiType</span><span class="p">(</span><span class="n">RESOURCES</span> <span class="o">/</span> <span class="s2">&quot;ui_components&quot;</span> <span class="o">/</span> <span class="s2">&quot;chroma_gui.ui&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rcparams_window_class</span> <span class="o">=</span> <span class="n">uic</span><span class="o">.</span><span class="n">loadUiType</span><span class="p">(</span><span class="n">RESOURCES</span> <span class="o">/</span> <span class="s2">&quot;ui_components&quot;</span> <span class="o">/</span> <span class="s2">&quot;mpl_rcparams.ui&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="ChromaticityTableModel">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.ChromaticityTableModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ChromaticityTableModel</span><span class="p">(</span><span class="n">QAbstractTableModel</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">QAbstractTableModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataframe</span> <span class="o">=</span> <span class="n">dataframe</span>

<div class="viewcode-block" id="ChromaticityTableModel.rowCount">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.ChromaticityTableModel.rowCount">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rowCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">QModelIndex</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override method from QAbstractTableModel</span>

<span class="sd">        Return row count of the pandas DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="n">QModelIndex</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataframe</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="ChromaticityTableModel.columnCount">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.ChromaticityTableModel.columnCount">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">columnCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">QModelIndex</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override method from QAbstractTableModel</span>

<span class="sd">        Return column count of the pandas DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="n">QModelIndex</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="ChromaticityTableModel.data">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.ChromaticityTableModel.data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override method from QAbstractTableModel</span>

<span class="sd">        Return data cell from the pandas DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">TextAlignmentRole</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AlignRight</span>

        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">index</span><span class="o">.</span><span class="n">column</span><span class="p">()])</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ChromaticityTableModel.headerData">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.ChromaticityTableModel.headerData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">headerData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">orientation</span><span class="p">:</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override method from QAbstractTableModel</span>

<span class="sd">        Return dataframe index as vertical header data and columns as horizontal header data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">getDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataframe</span></div>



<div class="viewcode-block" id="Measurement">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.Measurement">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Measurement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    holds measurement specific data such as paths and measurement times</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Paths for the measurement itself and the two beam models</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;B1&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="c1"># Metadata about the measurement</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Settings for extraction and analysis</span>
    <span class="n">nominal_rf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Extraction times</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">end_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Analysis times</span>
    <span class="n">cleaning_start_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cleaning_end_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Measurement.from_folder">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.Measurement.from_folder">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_folder</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Measurement</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a Measurement object created via the &quot;measurement.info&quot; contained in the given folder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">measurement_info_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;measurement.info&quot;</span>
        <span class="n">measurement_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">measurement_info_path</span><span class="p">))</span>

        <span class="n">measurement</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">measurement_info</span><span class="p">)</span>

        <span class="c1"># Fix the datetime and Path types as we&#39;re only reading strings from the json</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="n">measurement</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">datetime</span><span class="p">:</span>  <span class="c1"># Dates</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">Path</span><span class="p">:</span>  <span class="c1"># Paths</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>  <span class="c1"># Dictionaries with Paths</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">measurement</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;B1&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">alpha</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">twiss</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">[</span><span class="n">beam</span><span class="p">])</span> <span class="o">/</span> <span class="s2">&quot;twiss.dat&quot;</span><span class="p">)</span>
            <span class="n">alpha</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">=</span> <span class="n">twiss</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;ALFA&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">alpha</span>

<div class="viewcode-block" id="Measurement.get_timber_status">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.Measurement.get_timber_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_timber_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a timber extraction data exists and return a small message with details.</span>
<span class="sd">        Otherwise, just say there is nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path_timber_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">timber</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">)</span>
        <span class="n">path_timber_raw</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">timber</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">FILENAME_HDF</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path_timber_data</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># First add the metadata from the timber extraction</span>
            <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">extracted_on</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_timber_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;Start Time&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;End Time&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;Extracted on&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">extracted_on</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                        <span class="k">break</span>
            <span class="c1"># Add some text to check if the raw data has been extracted already</span>
            <span class="n">raw_extracted</span> <span class="o">=</span> <span class="n">path_timber_raw</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Existing extracted data:&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">extracted_on</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raw extracted: </span><span class="si">{</span><span class="n">raw_extracted</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">message</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No extraction in directory yet&quot;</span><span class="p">,</span> <span class="kc">False</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_cleaning_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_dpp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">path_cleaned</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">path_dpp</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="n">path_cleaned</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_chroma_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_chroma</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">CHROMA_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path_chroma</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path_chroma</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">chroma_tfs</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;MIN_FIT_ORDER&quot;</span><span class="p">],</span> <span class="n">chroma_tfs</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;MAX_FIT_ORDER&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

<div class="viewcode-block" id="Measurement.save_as_json">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.Measurement.save_as_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the measurement fields as json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">measurement_info_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;measurement.info&quot;</span>

        <span class="c1"># Converts the types to something json can serialize</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">datetime</span><span class="p">:</span>  <span class="c1"># Dates</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">Path</span><span class="p">:</span>  <span class="c1"># Paths</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>  <span class="c1"># Dictionaries with Paths</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">measurement_info_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ExternalProgram">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.ExternalProgram">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExternalProgram</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

        <span class="c1"># Base progress is added to the progress bar as the cleaning is done on two independent beams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Connect the progress signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extractTimber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the arguments from the creation of the object</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

        <span class="c1"># Tell the user we&#39;re extracting</span>
        <span class="n">main_window</span> <span class="o">=</span> <span class="n">findMainWindow</span><span class="p">()</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">statusTimberExtractionLabel</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Extracting data from Timberâ€¦&quot;</span><span class="p">)</span>

        <span class="c1"># Extract the data from timber</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting PyTimber extraction&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">timber</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">extract_usual_variables</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="c1"># Save the data in the measurement path</span>
        <span class="n">measurement_path</span> <span class="o">=</span> <span class="n">main_window</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span>
        <span class="n">timber</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">save_as_csv</span><span class="p">(</span><span class="n">measurement_path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># If the user tells us to extract the RAW data, save it</span>
        <span class="k">if</span> <span class="n">main_window</span><span class="o">.</span><span class="n">rawBBQCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">timber</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">extract_raw_variables</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="c1"># timber.extract.save_as_pickle(measurement_path, data)</span>
            <span class="n">timber</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">save_as_hdf</span><span class="p">(</span><span class="n">measurement_path</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PyTimber extraction finished&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">createPlateaus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">rf_beam</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">nominal_rf</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="n">plateau</span><span class="o">.</span><span class="n">create_plateau</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">rf_beam</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">end_time</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
            <span class="n">nominal_rf</span><span class="o">=</span><span class="n">nominal_rf</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanTune</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">input_file_B1</span><span class="p">,</span>
            <span class="n">input_file_B2</span><span class="p">,</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">output_filename_B1</span><span class="p">,</span>
            <span class="n">output_filename_B2</span><span class="p">,</span>
            <span class="n">qx_window</span><span class="p">,</span>
            <span class="n">qy_window</span><span class="p">,</span>
            <span class="n">quartiles</span><span class="p">,</span>
            <span class="n">plateau_length</span><span class="p">,</span>
            <span class="n">bad_tunes</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

        <span class="c1"># Reset the progress bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Beam 1</span>
        <span class="n">clean</span><span class="o">.</span><span class="n">clean_data_for_beam</span><span class="p">(</span>
            <span class="n">input_file_B1</span><span class="p">,</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">output_filename_B1</span><span class="p">,</span>
            <span class="n">qx_window</span><span class="p">,</span>
            <span class="n">qy_window</span><span class="p">,</span>
            <span class="n">quartiles</span><span class="p">,</span>
            <span class="n">plateau_length</span><span class="p">,</span>
            <span class="n">bad_tunes</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bbq&quot;</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Beam 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_progress</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># max value is 200</span>
        <span class="n">clean</span><span class="o">.</span><span class="n">clean_data_for_beam</span><span class="p">(</span>
            <span class="n">input_file_B2</span><span class="p">,</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">output_filename_B2</span><span class="p">,</span>
            <span class="n">qx_window</span><span class="p">,</span>
            <span class="n">qy_window</span><span class="p">,</span>
            <span class="n">quartiles</span><span class="p">,</span>
            <span class="n">plateau_length</span><span class="p">,</span>
            <span class="n">bad_tunes</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bbq&quot;</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">progress_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="n">main_window</span> <span class="o">=</span> <span class="n">findMainWindow</span><span class="p">()</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">cleaningProgressBar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_progress</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">progress</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanTuneRawBBQ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">input_file</span><span class="p">,</span>
            <span class="n">input_file_raw</span><span class="p">,</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">output_filename_B1</span><span class="p">,</span>
            <span class="n">output_filename_B2</span><span class="p">,</span>
            <span class="n">qx_window</span><span class="p">,</span>
            <span class="n">qy_window</span><span class="p">,</span>
            <span class="n">plateau_length</span><span class="p">,</span>
            <span class="n">seconds_step</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="p">,</span>
            <span class="n">method</span><span class="p">,</span>
            <span class="n">bad_tunes</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

        <span class="n">quartiles</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Reset the progress bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Beam 1</span>
        <span class="n">clean</span><span class="o">.</span><span class="n">clean_data_for_beam</span><span class="p">(</span>
            <span class="n">input_file</span><span class="p">,</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">output_filename_B1</span><span class="p">,</span>
            <span class="n">qx_window</span><span class="p">,</span>
            <span class="n">qy_window</span><span class="p">,</span>
            <span class="n">quartiles</span><span class="p">,</span>
            <span class="n">plateau_length</span><span class="p">,</span>
            <span class="n">bad_tunes</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">raw_bbq_file</span><span class="o">=</span><span class="n">input_file_raw</span><span class="p">,</span>
            <span class="n">seconds_step</span><span class="o">=</span><span class="n">seconds_step</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
            <span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Beam 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_progress</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">clean</span><span class="o">.</span><span class="n">clean_data_for_beam</span><span class="p">(</span>
            <span class="n">input_file</span><span class="p">,</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">output_filename_B2</span><span class="p">,</span>
            <span class="n">qx_window</span><span class="p">,</span>
            <span class="n">qy_window</span><span class="p">,</span>
            <span class="n">quartiles</span><span class="p">,</span>
            <span class="n">plateau_length</span><span class="p">,</span>
            <span class="n">bad_tunes</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">raw_bbq_file</span><span class="o">=</span><span class="n">input_file_raw</span><span class="p">,</span>
            <span class="n">seconds_step</span><span class="o">=</span><span class="n">seconds_step</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
            <span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">computeChroma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_file_B1</span><span class="p">,</span> <span class="n">input_file_B2</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">fit_orders</span><span class="p">,</span> <span class="n">dpp_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

        <span class="c1"># Construct the resulting TFS</span>
        <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">construct_chroma_tfs</span><span class="p">(</span><span class="n">fit_orders</span><span class="p">)</span>

        <span class="c1"># Beam 1</span>
        <span class="k">if</span> <span class="n">input_file_B1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">get_chromaticity</span><span class="p">(</span><span class="n">input_file_B1</span><span class="p">,</span> <span class="n">chroma_tfs</span><span class="p">,</span> <span class="n">dpp_range</span><span class="p">,</span> <span class="n">fit_orders</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
            <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">get_chromaticity</span><span class="p">(</span><span class="n">input_file_B1</span><span class="p">,</span> <span class="n">chroma_tfs</span><span class="p">,</span> <span class="n">dpp_range</span><span class="p">,</span> <span class="n">fit_orders</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>

        <span class="c1"># Beam 2</span>
        <span class="k">if</span> <span class="n">input_file_B2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">get_chromaticity</span><span class="p">(</span><span class="n">input_file_B2</span><span class="p">,</span> <span class="n">chroma_tfs</span><span class="p">,</span> <span class="n">dpp_range</span><span class="p">,</span> <span class="n">fit_orders</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
            <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">get_chromaticity</span><span class="p">(</span><span class="n">input_file_B2</span><span class="p">,</span> <span class="n">chroma_tfs</span><span class="p">,</span> <span class="n">dpp_range</span><span class="p">,</span> <span class="n">fit_orders</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>

        <span class="n">tfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_path</span> <span class="o">/</span> <span class="n">CHROMA_FILE</span><span class="p">,</span> <span class="n">chroma_tfs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">computeCorrections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">optics_paths</span><span class="p">,</span>
            <span class="n">measurement_path</span><span class="p">,</span>
            <span class="n">method</span><span class="p">,</span>
            <span class="n">observables</span><span class="p">,</span>
            <span class="n">chroma_factor</span><span class="p">,</span>
            <span class="n">rcond</span><span class="p">,</span>
            <span class="n">keep_dq3_constant</span><span class="p">,</span>
            <span class="n">keep_rdt_constant</span><span class="p">,</span>
            <span class="n">clean_nan</span><span class="p">,</span>
            <span class="n">clean_outliers</span><span class="p">,</span>
            <span class="n">clean_IR_number</span><span class="p">,</span>
            <span class="n">optics_name</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
        <span class="n">corr_sum</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Global&quot;</span><span class="p">:</span>
            <span class="n">chromaticity_values</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">measurement_path</span> <span class="o">/</span> <span class="n">CHROMA_FILE</span><span class="p">)</span>
            <span class="n">coefficients</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">CHROMA_COEFFS</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">observables</span><span class="p">:</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;DQ&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># Get the measured values</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">chromaticity_values</span><span class="p">[</span><span class="s2">&quot;BEAM&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">chromaticity_values</span><span class="p">[</span><span class="s2">&quot;UP_TO_ORDER&quot;</span><span class="p">]</span>
                        <span class="o">==</span> <span class="n">chromaticity_values</span><span class="p">[</span><span class="s2">&quot;UP_TO_ORDER&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">mask_x</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chromaticity_values</span><span class="p">[</span><span class="s2">&quot;AXIS&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
                    <span class="n">mask_y</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chromaticity_values</span><span class="p">[</span><span class="s2">&quot;AXIS&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>
                    <span class="n">dqx</span> <span class="o">=</span> <span class="n">chromaticity_values</span><span class="p">[</span><span class="n">mask_x</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;Q</span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dqy</span> <span class="o">=</span> <span class="n">chromaticity_values</span><span class="p">[</span><span class="n">mask_y</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;Q</span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># The chromaticity is simply an affine function that depends on the corrector strength</span>
                    <span class="c1"># Get the point where dqx and dqy cross to minimize both planes</span>
                    <span class="n">dq_corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dqy</span> <span class="o">-</span> <span class="n">dqx</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="n">coefficients</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">beam</span><span class="p">)][</span><span class="n">order</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coefficients</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">beam</span><span class="p">)][</span><span class="n">order</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">text</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;DQ</span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">Corrector.B</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">dq_corr</span><span class="si">:</span><span class="s2">6.4f</span><span class="si">}</span><span class="s2"> ;</span><span class="se">\n</span><span class="s2">&quot;</span>

                    <span class="c1"># Update the sum</span>
                    <span class="n">corr_sum</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dq_corr</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">:</span>
            <span class="c1"># Compute the corrections for each beam</span>
            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing corrections for Beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Get the strengths of the magnets used for simulation</span>
                <span class="n">strengths_mcd</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="nb">open</span><span class="p">(</span>
                        <span class="n">RESOURCES</span>
                        <span class="o">/</span> <span class="s2">&quot;corrections&quot;</span>
                        <span class="o">/</span> <span class="n">optics_name</span>
                        <span class="o">/</span> <span class="s2">&quot;normal_decapole&quot;</span>
                        <span class="o">/</span> <span class="s2">&quot;strengths.json&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Create the basic response matrix object</span>
                <span class="n">simulations</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">RESOURCES</span> <span class="o">/</span> <span class="s2">&quot;corrections&quot;</span> <span class="o">/</span> <span class="n">optics_name</span> <span class="o">/</span> <span class="s2">&quot;normal_decapole&quot;</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">response_matrix</span><span class="o">.</span><span class="n">ResponseMatrix</span><span class="p">(</span>
                    <span class="n">strengths_mcd</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">beam</span><span class="p">)],</span> <span class="n">simulations</span><span class="p">,</span> <span class="n">beam</span><span class="o">=</span><span class="n">beam</span>
                <span class="p">)</span>

                <span class="c1"># Add the observables</span>
                <span class="c1"># Add the RDT to the response matrix</span>
                <span class="k">if</span> <span class="n">keep_rdt_constant</span><span class="p">:</span>
                    <span class="n">model_path</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">RESOURCES</span>
                        <span class="o">/</span> <span class="s2">&quot;corrections&quot;</span>
                        <span class="o">/</span> <span class="n">optics_name</span>
                        <span class="o">/</span> <span class="s2">&quot;normal_decapole&quot;</span>
                        <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;twiss_b</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">.tfs&quot;</span>
                    <span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">add_zero_rdt_observable</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s2">&quot;f1004_x&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;f1004&quot;</span> <span class="ow">in</span> <span class="n">observables</span><span class="p">:</span>
                    <span class="n">optics_path</span> <span class="o">=</span> <span class="n">optics_paths</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span>
                    <span class="n">model_path</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">RESOURCES</span>
                        <span class="o">/</span> <span class="s2">&quot;corrections&quot;</span>
                        <span class="o">/</span> <span class="n">optics_name</span>
                        <span class="o">/</span> <span class="s2">&quot;normal_decapole&quot;</span>
                        <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;twiss_b</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">.tfs&quot;</span>
                    <span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">add_rdt_observable</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">optics_path</span><span class="p">),</span> <span class="n">model_path</span><span class="p">,</span> <span class="s2">&quot;f1004_x&quot;</span><span class="p">)</span>

                <span class="c1"># Add the Chromaticity to the response matrix</span>
                <span class="n">chroma_path</span> <span class="o">=</span> <span class="n">measurement_path</span>
                <span class="k">if</span> <span class="n">keep_dq3_constant</span><span class="p">:</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">add_zero_chromaticity_observable</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">chroma_factor</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;DQ3&quot;</span> <span class="ow">in</span> <span class="n">observables</span><span class="p">:</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">add_chromaticity_observable</span><span class="p">(</span><span class="n">chroma_path</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">chroma_factor</span><span class="p">)</span>

                <span class="c1"># Get the corrections</span>
                <span class="n">corrections</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_corrections</span><span class="p">(</span>
                    <span class="n">rcond</span><span class="o">=</span><span class="n">rcond</span><span class="p">,</span>
                    <span class="n">clean_nan</span><span class="o">=</span><span class="n">clean_nan</span><span class="p">,</span>
                    <span class="n">clean_outliers</span><span class="o">=</span><span class="n">clean_outliers</span><span class="p">,</span>
                    <span class="n">clean_IR</span><span class="o">=</span><span class="p">(</span><span class="n">clean_IR_number</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">inside_arc_number</span><span class="o">=</span><span class="n">clean_IR_number</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Set the text edits with the computed corrections</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">corrections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">text</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> := </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> ;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">text</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> := </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">val</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ;</span><span class="se">\n</span><span class="s2">&quot;</span>

                    <span class="n">corr_sum</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid method for corrections: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Set the text for the corrections</span>
        <span class="n">main_window</span> <span class="o">=</span> <span class="n">findMainWindow</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">main_window</span><span class="o">.</span><span class="n">corrections</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span>

        <span class="c1"># Display the sum of corrections</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">sumB1Label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">corr_sum</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">sumB2Label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">corr_sum</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>



<div class="viewcode-block" id="CheckableComboBox">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.CheckableComboBox">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CheckableComboBox</span><span class="p">(</span><span class="n">QComboBox</span><span class="p">):</span>
    <span class="c1"># Subclass Delegate to increase item height</span>
<div class="viewcode-block" id="CheckableComboBox.Delegate">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.CheckableComboBox.Delegate">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">Delegate</span><span class="p">(</span><span class="n">QStyledItemDelegate</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">sizeHint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">size</span><span class="o">.</span><span class="n">setHeight</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">size</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Make the combo editable to set a custom text, but readonly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setEditable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="p">()</span><span class="o">.</span><span class="n">setReadOnly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Make the lineedit the same color as QPushButton</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="n">qApp</span><span class="o">.</span><span class="n">palette</span><span class="p">()</span>
        <span class="n">palette</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">QPalette</span><span class="o">.</span><span class="n">Base</span><span class="p">,</span> <span class="n">palette</span><span class="o">.</span><span class="n">button</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="p">()</span><span class="o">.</span><span class="n">setPalette</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>

        <span class="c1"># Use custom delegate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setItemDelegate</span><span class="p">(</span><span class="n">CheckableComboBox</span><span class="o">.</span><span class="n">Delegate</span><span class="p">())</span>

        <span class="c1"># Update the text when an item is toggled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">dataChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">updateText</span><span class="p">)</span>

        <span class="c1"># Hide and show popup when clicking the line edit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="p">()</span><span class="o">.</span><span class="n">installEventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeOnLineEditClick</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Prevent popup from closing when clicking on an item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">()</span><span class="o">.</span><span class="n">viewport</span><span class="p">()</span><span class="o">.</span><span class="n">installEventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="c1"># Recompute text to elide as needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateText</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">resizeEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">object</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QEvent</span><span class="o">.</span><span class="n">MouseButtonRelease</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeOnLineEditClick</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hidePopup</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">showPopup</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">object</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">()</span><span class="o">.</span><span class="n">viewport</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QEvent</span><span class="o">.</span><span class="n">MouseButtonRelease</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">()</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Checked</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Checked</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">showPopup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">showPopup</span><span class="p">()</span>
        <span class="c1"># When the popup is displayed, a click on the lineedit should close it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeOnLineEditClick</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hidePopup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">hidePopup</span><span class="p">()</span>
        <span class="c1"># Used to prevent immediate reopening when clicking on the lineEdit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startTimer</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Refresh the display text when closing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateText</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timerEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="c1"># After timeout, kill timer, and reenable click on line edit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">killTimer</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">timerId</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeOnLineEditClick</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">updateText</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Checked</span><span class="p">:</span>
                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>

        <span class="c1"># Compute elided text (with &quot;...&quot;)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">QFontMetrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="p">()</span><span class="o">.</span><span class="n">font</span><span class="p">())</span>
        <span class="n">elidedText</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">elidedText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ElideRight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEdit</span><span class="p">()</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">elidedText</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">addItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">QStandardItem</span><span class="p">()</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsUserCheckable</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CheckStateRole</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">appendRow</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">addItems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">datalist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">datalist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">currentData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Return the list of selected items data</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Checked</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="Config">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.Config">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for storing user preferences</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># New Measurement Window</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/user/slops/data/LHC_DATA/OP_DATA/Betabeat/&quot;</span><span class="p">)</span>
    <span class="n">measurements_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/user/slops/data/LHC_DATA/OP_DATA/Betabeat/&quot;</span><span class="p">)</span>

    <span class="c1"># Timber</span>
    <span class="n">extract_raw_timber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Cleaning</span>
    <span class="n">rf_beam</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">qx_window</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.31</span><span class="p">)</span>
    <span class="n">qy_window</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.29</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">)</span>
    <span class="n">quartiles</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">)</span>
    <span class="n">plateau_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">bad_tune_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[(</span><span class="mf">0.2665</span><span class="p">,</span> <span class="mf">0.2670</span><span class="p">)])</span>

    <span class="n">plot_dpp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">plot_delta_rf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Matplotlib rcParams</span>
    <span class="n">rcParams</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">obj</span><span class="p">)</span>

<div class="viewcode-block" id="Config.save_field">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.Config.save_field">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the config file and change the given field</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving config field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Read the config</span>
        <span class="n">config_fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_fp</span><span class="p">)</span>
        <span class="n">file</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">config_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Write it</span>
        <span class="n">config_fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">config_fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="exceptHook">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.exceptHook">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">exceptHook</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function called when an exception occurs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>

    <span class="c1"># Close the running thread if it caused the crash</span>
    <span class="c1"># Otherwise, it might just be the GUI</span>
    <span class="n">main_window</span> <span class="o">=</span> <span class="n">findMainWindow</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Inform the user in the GUI that the function didn&#39;t run properly</span>
    <span class="n">stk</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">exc_tb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">function_name</span> <span class="o">=</span> <span class="n">stk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># function that caused the issue</span>
    <span class="k">if</span> <span class="n">function_name</span> <span class="o">==</span> <span class="s2">&quot;cleanTuneRawBBQ&quot;</span><span class="p">:</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">cleaningStatusLabel</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Cleaning failed!&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>



<div class="viewcode-block" id="MainWindow">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MainWindow</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">,</span> <span class="n">main_window_class</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">QMainWindow</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Put the version of the GUI in the title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-Linear Chromaticity GUI â€” v</span><span class="si">{</span><span class="n">chroma_gui_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Timber variables to display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectedTimberVariables</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Define the widgets for the plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB2Widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB2Widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB2Widget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1YWidget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2XWidget</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2YWidget</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Define table models for chromaticity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaB1TableModel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaB2TableModel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Load preferences for file structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">applyMplStyle</span><span class="p">()</span>

        <span class="c1"># Disable tabs for now, as no measurement has been created or opened yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enableTimberTab</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enableCleaningTab</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enableChromaticityTab</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enableCorrectionsTab</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">available_observables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;B1&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCorrectionComboBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setChromaticityComboBox</span><span class="p">()</span>

        <span class="c1"># Set the info icons on the labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setInfoIcons</span><span class="p">()</span>

        <span class="c1"># R2 scores for each chromaticity fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2scores</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;B1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s2">&quot;B2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>

<div class="viewcode-block" id="MainWindow.setInfoIcons">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.setInfoIcons">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setInfoIcons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate through all the labels in the class that have a tooltip, and place a proper info icon next to it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">QLabel</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="n">tooltip</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">toolTip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tooltip</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="c1"># Create a H layout that will old the text / icon</span>
                    <span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
                    <span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">info_icon_id</span> <span class="o">=</span> <span class="s2">&quot;fa5s.question-circle&quot;</span>
                    <span class="n">icon</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
                    <span class="n">icon</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">qta</span><span class="o">.</span><span class="n">icon</span><span class="p">(</span><span class="n">info_icon_id</span><span class="p">)</span><span class="o">.</span><span class="n">pixmap</span><span class="p">(</span><span class="n">QSize</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)))</span>

                    <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span><span class="p">)</span>
                    <span class="n">layout</span><span class="o">.</span><span class="n">addSpacing</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span><span class="p">)</span>

                    <span class="c1"># Set the original tool tip to the icon</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">icon</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>

                    <span class="n">obj</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># remove the old text</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>  <span class="c1"># and replace by the new layout</span>
                    <span class="n">layout</span><span class="o">.</span><span class="n">setSizeConstraint</span><span class="p">(</span><span class="n">QLayout</span><span class="o">.</span><span class="n">SetMinimumSize</span><span class="p">)</span>
                    <span class="n">layout</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span><span class="p">)</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">applyMplStyle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rcParams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">RESOURCES</span> <span class="o">/</span> <span class="s2">&quot;chroma_gui.mplstyle&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loadConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>

        <span class="c1"># Fix the value types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">measurements_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">measurements_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tune_window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">bad_tune_lines</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">bad_tune_lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tune_window</span><span class="p">)</span>

        <span class="c1"># Set the different line edits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qxWindowLow</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qx_window</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qxWindowHigh</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qx_window</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qyWindowLow</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qy_window</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qyWindowHigh</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qy_window</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q1Quartile</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">quartiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q3Quartile</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">quartiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfBeamComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rf_beam</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># Index starts at 0: Beam - 1 = index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plateauLength</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">plateau_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">badTunesLineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">bad_tune_lines</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rawBBQCheckBox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">extract_raw_timber</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showDppCheckBox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">plot_dpp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showDeltaRfCheckBox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">plot_delta_rf</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">updateLineEdits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Update the labels in the Main Window</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alfaB1LineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alfaB2LineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="s2">&quot;B2&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominalRfLineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">nominal_rf</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptionPlainTextEdit</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># Set the extraction dates via Qt objects</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">QDateTime</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">),</span> <span class="s2">&quot;yyyy-MM-ddThh:mm:ss&quot;</span>
        <span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">QDateTime</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">),</span> <span class="s2">&quot;yyyy-MM-ddThh:mm:ss&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startTimeTimberEdit</span><span class="o">.</span><span class="n">setDateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endTimeTimberEdit</span><span class="o">.</span><span class="n">setDateTime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

        <span class="c1"># Write if an extraction already exists with some details about the date</span>
        <span class="n">message</span><span class="p">,</span> <span class="n">extracted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">get_timber_status</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusTimberExtractionLabel</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># Enable the Timber tab for the first time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enableTimberTab</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Enable the cleaning tab if we&#39;ve got extracted data</span>
        <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateTimberPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateTimberTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enableCleaningTab</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Get the times from the measurement.info, or set them to the Timber extraction times</span>
            <span class="n">cleaning_start</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">QDateTime</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">cleaning_start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;yyyy-MM-ddThh:mm:ss&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">cleaning_start_time</span>
                <span class="k">else</span> <span class="n">start</span>
            <span class="p">)</span>
            <span class="n">cleaning_end</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">QDateTime</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">cleaning_end_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;yyyy-MM-ddThh:mm:ss&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">cleaning_end_time</span>
                <span class="k">else</span> <span class="n">end</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startPlateauDateTimeEdit</span><span class="o">.</span><span class="n">setDateTime</span><span class="p">(</span><span class="n">cleaning_start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endPlateauDateTimeEdit</span><span class="o">.</span><span class="n">setDateTime</span><span class="p">(</span><span class="n">cleaning_end</span><span class="p">)</span>

        <span class="c1"># Check if we got cleaned data already</span>
        <span class="n">dpp</span><span class="p">,</span> <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">get_cleaning_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dpp</span><span class="p">:</span>  <span class="c1"># If we have created plateaus, plot them</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plateauFinished</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If we don&#39;t have plateaus, there is no need to display the cleaning yet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleaningWidget</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cleaned</span><span class="p">:</span>  <span class="c1"># the cleaned data exist, it can be plotted!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleaningFinished</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enableChromaticityTab</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">chroma_status</span><span class="p">,</span> <span class="n">chroma_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">get_chroma_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">chroma_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setChromaticityOrders</span><span class="p">(</span><span class="n">chroma_orders</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chromaFinished</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>

<div class="viewcode-block" id="MainWindow.setChromaticityComboBox">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.setChromaticityComboBox">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setChromaticityComboBox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a combobox with clickable numbers for the chromaticity function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderLayout</span><span class="o">.</span><span class="n">removeWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Create a new custom ComboBox and add it to the layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span> <span class="o">=</span> <span class="n">CheckableComboBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderLayout</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># Display the available correction methods</span>
        <span class="n">max_chroma</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_chroma</span><span class="p">))])</span></div>


<div class="viewcode-block" id="MainWindow.setCorrectionComboBox">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.setCorrectionComboBox">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setCorrectionComboBox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function replaces the ComboBox containing the observables by one with items that can be clicked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove the existing widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layoutObservables</span><span class="o">.</span><span class="n">removeWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observablesCorrectionComboBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observablesCorrectionComboBox</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Create a new custom ComboBox and add it to the layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observablesCorrectionComboBox</span> <span class="o">=</span> <span class="n">CheckableComboBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layoutObservables</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observablesCorrectionComboBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layoutObservables</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># Display the available correction methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_observables</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">RESPONSE_MATRICES</span><span class="p">))[</span><span class="s2">&quot;AVAILABLE_OBSERVABLES&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correctionMethodComboBox</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_observables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Set the possible optics the response matrix was computed for</span>
        <span class="n">optics</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">(</span><span class="n">RESOURCES</span> <span class="o">/</span> <span class="s2">&quot;corrections&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opticsComboBox</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">optics</span><span class="p">)</span></div>


<div class="viewcode-block" id="MainWindow.correctionMethodComboBoxChanged">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.correctionMethodComboBoxChanged">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">correctionMethodComboBoxChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the available observables for the selected method.</span>
<span class="sd">        Greys out the unavailable options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctionMethodComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>

        <span class="c1"># Set the available observables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observablesCorrectionComboBox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observablesCorrectionComboBox</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_observables</span><span class="p">[</span><span class="n">selected_method</span><span class="p">])</span>

        <span class="c1"># Greys out the options of the method is global</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurementCorrectionB1LineEdit</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurementCorrectionB2LineEdit</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factorChromaSpinBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcondCorrectionSpinBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keepDQ3ConstantcheckBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanNaNCheckBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanOutliersCheckBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanIRSpinBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opticsComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">selected_method</span> <span class="o">==</span> <span class="s2">&quot;Local&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">enableTimberTab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timberTab</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enableCleaningTab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaningTab</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enableChromaticityTab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaticityTab</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enableCorrectionsTab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correctionsTab</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">newMeasurementClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">measurement_dialog</span> <span class="o">=</span> <span class="n">NewMeasurementDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">measurement_dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">openMeasurementClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;Select Measurement Directory&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">measurements_path</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Failed to open directory&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;The directory &#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&#39; could not be opened&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Try to open the measurement information file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="n">Measurement</span><span class="o">.</span><span class="n">from_folder</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Failed to open measurement&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s2">&quot;Failed to open measurement&quot;</span><span class="p">,</span>
                <span class="s2">&quot;The file &#39;measurement.info&#39; is not a valid JSON file&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s2">&quot;Failed to open measurement&quot;</span><span class="p">,</span>
                <span class="s2">&quot;The file &#39;measurement.info&#39; does not contain the required keys&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateLineEdits</span><span class="p">()</span>

<div class="viewcode-block" id="MainWindow.saveSettingsClicked">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.saveSettingsClicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">saveSettingsClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the settings into the measurement file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if a measurement has been opened or created already, otherwise why would we save something?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No measurement has been opened or created, the settings can&#39;t be saved.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Nominal RF</span>
        <span class="n">nominal_rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominalRfLineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nominal_rf</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">or</span> <span class="n">nominal_rf</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">nominal_rf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">nominal_rf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nominal_rf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nominal_rf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">nominal_rf</span> <span class="o">=</span> <span class="n">nominal_rf</span>

        <span class="c1"># Description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptionPlainTextEdit</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>

        <span class="c1"># Save the measurement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">save_as_json</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Settings saved!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MainWindow.startThread">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.startThread">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">startThread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_function</span><span class="p">,</span> <span class="n">finish_function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple wrapper to start a thread</span>
<span class="sd">        Arguments:</span>
<span class="sd">            - main_function: method of the class `ExternalProgram` to be started as main function of the thread</span>
<span class="sd">            - finish_function: method of the class  `MainWindow` to be called when the thread has finished</span>
<span class="sd">            - args: arguments to be passed to the instantiation of the `ExternalProgram` class, </span>
<span class="sd">            those are the `main_function` arguments</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if we&#39;ve got a thread already running</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;A thread is already running, please wait for it to finish&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>  <span class="c1"># The thread has been deleted, it&#39;s all good</span>
            <span class="k">pass</span>

        <span class="c1"># Create the thread and the class with our functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">ExternalProgram</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Move worker to the thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span>

        <span class="c1"># Connect signals and slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="n">main_function</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finish_function</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>

        <span class="c1"># Start the thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">extractTimberClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTimeTimberEdit</span><span class="o">.</span><span class="n">dateTime</span><span class="p">()</span><span class="o">.</span><span class="n">toPyDateTime</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTimeTimberEdit</span><span class="o">.</span><span class="n">dateTime</span><span class="p">()</span><span class="o">.</span><span class="n">toPyDateTime</span><span class="p">()</span>

        <span class="c1"># Set the start and end times to the Measurement object, and save it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">save_as_json</span><span class="p">()</span>

        <span class="c1"># Start the extraction</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Timber extraction&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startThread</span><span class="p">(</span><span class="s2">&quot;extractTimber&quot;</span><span class="p">,</span> <span class="s2">&quot;timberExtractionFinished&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">createPlateausClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startPlateauDateTimeEdit</span><span class="o">.</span><span class="n">dateTime</span><span class="p">()</span><span class="o">.</span><span class="n">toPyDateTime</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endPlateauDateTimeEdit</span><span class="o">.</span><span class="n">dateTime</span><span class="p">()</span><span class="o">.</span><span class="n">toPyDateTime</span><span class="p">()</span>
        <span class="n">rf_beam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfBeamComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span>
        <span class="n">nominal_rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominalRfLineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

        <span class="c1"># Check of the nominal RF exists</span>
        <span class="c1"># If it is 0 or None, the plateau creation will take the first value in the dataFrame</span>
        <span class="k">if</span> <span class="n">nominal_rf</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">or</span> <span class="n">nominal_rf</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">nominal_rf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The nominal frequency is not set. The first point of the data extracted will be taken. &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Be sure that this point is the expected one!&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nominal_rf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nominal_rf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nominal_rf</span><span class="p">)</span>

        <span class="c1"># Set the analysis start and end time in the measurement.info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">cleaning_start_time</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">cleaning_end_time</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">save_as_json</span><span class="p">()</span>

        <span class="c1"># Start the plateau creation</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Plateau Creation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startThread</span><span class="p">(</span>
            <span class="s2">&quot;createPlateaus&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plateauFinished&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="n">timber</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">,</span>
            <span class="n">rf_beam</span><span class="p">,</span>
            <span class="n">start</span><span class="p">,</span>
            <span class="n">end</span><span class="p">,</span>
            <span class="n">nominal_rf</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanDataClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get values from the GUI</span>
        <span class="c1"># Tune Window</span>
        <span class="n">qx_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qxWindowLow</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">qx_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qxWindowHigh</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">qy_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qyWindowLow</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">qy_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qyWindowHigh</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="c1"># Quartiles</span>
        <span class="n">q1_quartile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1Quartile</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">q3_quartile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q3Quartile</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="c1"># Minimum Plateau Length</span>
        <span class="n">plateau_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plateauLength</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="c1"># Raw BBQ specific options</span>
        <span class="n">seconds_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondsStep</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">kernel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernelSize</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="c1"># Bad tune lines: list of tuples, e.g. [(0.26, 0.28), ]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bad_tunes</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">badTunesLineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">,</span> <span class="ne">RecursionError</span><span class="p">):</span>
            <span class="n">bad_tunes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not load the bad tunes line. Defaulting to none.&quot;</span><span class="p">)</span>

        <span class="c1"># Set the cleaning label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaningStatusLabel</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Cleaning in progressâ€¦&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Tune Cleaning&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useRawBBQCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>  <span class="c1"># classic BBQ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startThread</span><span class="p">(</span>
                <span class="s2">&quot;cleanTune&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cleaningFinished&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                <span class="p">(</span><span class="n">qx_low</span><span class="p">,</span> <span class="n">qx_high</span><span class="p">),</span>
                <span class="p">(</span><span class="n">qy_low</span><span class="p">,</span> <span class="n">qy_high</span><span class="p">),</span>
                <span class="p">(</span><span class="n">q1_quartile</span><span class="p">,</span> <span class="n">q3_quartile</span><span class="p">),</span>
                <span class="n">plateau_length</span><span class="p">,</span>
                <span class="n">bad_tunes</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># raw BBQ</span>
            <span class="c1"># Select the method to be called for processing the raw BBQ</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;raw_bbq_spectrogram&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useNAFFCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;raw_bbq_naff&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startThread</span><span class="p">(</span>
                <span class="s2">&quot;cleanTuneRawBBQ&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cleaningFinished&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">timber</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">FILENAME_HDF</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                <span class="p">(</span><span class="n">qx_low</span><span class="p">,</span> <span class="n">qx_high</span><span class="p">),</span>
                <span class="p">(</span><span class="n">qy_low</span><span class="p">,</span> <span class="n">qy_high</span><span class="p">),</span>
                <span class="n">plateau_length</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">seconds_step</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">),</span>
                <span class="n">method</span><span class="p">,</span>
                <span class="n">bad_tunes</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plateauFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plateaus done!&quot;</span><span class="p">)</span>
        <span class="c1"># This function is called during the Measurement object init when loading a directory</span>
        <span class="c1"># This means the &#39;measurement&#39; object isn&#39;t assigned yet to the main window, i.e. &#39;self.measurement&#39; is None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">measurement</span><span class="p">:</span>
            <span class="n">measurement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateDppPlot</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRawTunePlot</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaningWidget</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleaningFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning done!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaningStatusLabel</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Cleaning done&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enableChromaticityTab</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">measurement</span><span class="p">:</span>
            <span class="n">measurement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateCleanedTunePlot</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timberExtractionFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Update some UI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateLineEdits</span><span class="p">()</span>

<div class="viewcode-block" id="MainWindow.updateDppPlot">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.updateDppPlot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">updateDppPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a plot to show the DPP / RF measurement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove the existing plots, if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotDppB2Widget</span><span class="p">)</span>

        <span class="c1"># Create the Matplotlib widgets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB2Widget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>

        <span class="c1"># Add the widgets to the layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaningPlotB1Layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaningPlotB2Layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotDppB2Widget</span><span class="p">)</span>

        <span class="c1"># Beam 1</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_dpp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB1Widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Beam 2</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plot_dpp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotDppB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotDppB2Widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">updateRawTunePlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="c1"># Add a plot to show the tune before cleaning</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB2Widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB2Widget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawPlotB1Layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawPlotB2Layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB2Widget</span><span class="p">)</span>

        <span class="c1"># Options</span>
        <span class="n">dpp_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showDppCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">delta_rf_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showDeltaRfCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">show_qx_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showQxCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">show_qy_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showQyCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">show_rf_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showRfCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>

        <span class="c1"># Beam 1</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_freq</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">filepath</span><span class="p">,</span>
            <span class="s2">&quot;Raw Tune Measurement for Beam 1&quot;</span><span class="p">,</span>
            <span class="n">dpp_flag</span><span class="o">=</span><span class="n">dpp_flag</span><span class="p">,</span>
            <span class="n">delta_rf_flag</span><span class="o">=</span><span class="n">delta_rf_flag</span><span class="p">,</span>
            <span class="n">qx_flag</span><span class="o">=</span><span class="n">show_qx_flag</span><span class="p">,</span>
            <span class="n">qy_flag</span><span class="o">=</span><span class="n">show_qy_flag</span><span class="p">,</span>
            <span class="n">rf_flag</span><span class="o">=</span><span class="n">show_rf_flag</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB1Widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Beam 2</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plot_freq</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">filepath</span><span class="p">,</span>
            <span class="s2">&quot;Raw Tune Measurement for Beam 2&quot;</span><span class="p">,</span>
            <span class="n">dpp_flag</span><span class="o">=</span><span class="n">dpp_flag</span><span class="p">,</span>
            <span class="n">delta_rf_flag</span><span class="o">=</span><span class="n">delta_rf_flag</span><span class="p">,</span>
            <span class="n">qx_flag</span><span class="o">=</span><span class="n">show_qx_flag</span><span class="p">,</span>
            <span class="n">qy_flag</span><span class="o">=</span><span class="n">show_qy_flag</span><span class="p">,</span>
            <span class="n">rf_flag</span><span class="o">=</span><span class="n">show_rf_flag</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotRawTuneB2Widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">updateCleanedTunePlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting cleaned tune&quot;</span><span class="p">)</span>
        <span class="c1"># Add a plot to show the tune before cleaning</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB2Widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB2Widget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanPlotB1Layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanPlotB2Layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB2Widget</span><span class="p">)</span>

        <span class="c1"># Options</span>
        <span class="n">dpp_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showDppCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">delta_rf_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showDeltaRfCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">show_qx_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showQxCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">show_qy_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showQyCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">show_rf_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">showRfCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>

        <span class="c1"># Beam 1</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_freq</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">filepath</span><span class="p">,</span>
            <span class="s2">&quot;Cleaned Tune Measurement for Beam 1&quot;</span><span class="p">,</span>
            <span class="n">dpp_flag</span><span class="o">=</span><span class="n">dpp_flag</span><span class="p">,</span>
            <span class="n">delta_rf_flag</span><span class="o">=</span><span class="n">delta_rf_flag</span><span class="p">,</span>
            <span class="n">plot_style</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
            <span class="n">qx_flag</span><span class="o">=</span><span class="n">show_qx_flag</span><span class="p">,</span>
            <span class="n">qy_flag</span><span class="o">=</span><span class="n">show_qy_flag</span><span class="p">,</span>
            <span class="n">rf_flag</span><span class="o">=</span><span class="n">show_rf_flag</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB1Widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Beam 2</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plot_freq</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">filepath</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Cleaned Tune Measurement for Beam 2&quot;</span><span class="p">,</span>
            <span class="n">dpp_flag</span><span class="o">=</span><span class="n">dpp_flag</span><span class="p">,</span>
            <span class="n">delta_rf_flag</span><span class="o">=</span><span class="n">delta_rf_flag</span><span class="p">,</span>
            <span class="n">plot_style</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
            <span class="n">qx_flag</span><span class="o">=</span><span class="n">show_qx_flag</span><span class="p">,</span>
            <span class="n">qy_flag</span><span class="o">=</span><span class="n">show_qy_flag</span><span class="p">,</span>
            <span class="n">rf_flag</span><span class="o">=</span><span class="n">show_rf_flag</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB2Widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotCleanTuneB2Widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="c1"># Remove widget from the layout and delete the widget</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">widget</span>

<div class="viewcode-block" id="MainWindow.rePlotCleaningClicked">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.rePlotCleaningClicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rePlotCleaningClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This buttons allows to replot the plots in the cleaning tab without redoing the analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRawTunePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateCleanedTunePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span></div>


<div class="viewcode-block" id="MainWindow.getChromaticityOrders">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.getChromaticityOrders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getChromaticityOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list containing the checked chromaticity orders</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checked</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="o">.</span><span class="n">currentData</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">checked</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">computeChromaClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get values from the GUI</span>
        <span class="n">dpp_range_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dppRangeLowSpinBox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">dpp_range_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dppRangeHighSpinBox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="n">input_file_B1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">input_file_B2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span>
        <span class="n">fit_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChromaticityOrders</span><span class="p">()</span>
        <span class="n">dpp_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpp_range_low</span><span class="p">,</span> <span class="n">dpp_range_high</span><span class="p">)</span>

        <span class="c1"># Set the files to None if that beam didn&#39;t get a measurement</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_file_B1</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">input_file_B1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_file_B2</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">input_file_B2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Chromaticity Computing&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startThread</span><span class="p">(</span>
            <span class="s2">&quot;computeChroma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chromaFinished&quot;</span><span class="p">,</span>
            <span class="n">input_file_B1</span><span class="p">,</span>
            <span class="n">input_file_B2</span><span class="p">,</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">fit_orders</span><span class="p">,</span>
            <span class="n">dpp_range</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">chromaFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chromaticity finished computing&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">measurement</span><span class="p">:</span>
            <span class="n">measurement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateChromaTables</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateChromaPlots</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateR2scores</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enableCorrectionsTab</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">updateR2scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set the r2 scores</span>
        <span class="n">current_beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beamChromaticityTabWidget</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># index starts at 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2_x_value</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2scores</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">current_beam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;X&quot;</span><span class="p">],</span> <span class="mi">5</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2_y_value</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2scores</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">current_beam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="mi">5</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">updateChromaTablesForBeam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_beam</span><span class="p">):</span>
        <span class="n">current_beam</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># index starts at 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beamChromaticityTableView</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;chromaB</span><span class="si">{</span><span class="n">current_beam</span><span class="si">}</span><span class="s2">TableModel&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateR2scores</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">updateChromaTables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">CHROMA_FILE</span><span class="p">)</span>
        <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">get_maximum_chromaticity</span><span class="p">(</span><span class="n">chroma_tfs</span><span class="p">)</span>
        <span class="n">chroma_tfs</span> <span class="o">=</span> <span class="n">get_chromaticity_df_with_notation</span><span class="p">(</span><span class="n">chroma_tfs</span><span class="p">)</span>

        <span class="c1"># Update the Chromaticity Formula at the top of the table</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getChromaticityOrders</span><span class="p">())</span>
        <span class="n">latex_formula</span> <span class="o">=</span> <span class="n">get_chromaticity_formula</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="n">pixmap</span> <span class="o">=</span> <span class="n">mathTex_to_QPixmap</span><span class="p">(</span><span class="n">latex_formula</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaticityFormulaLabel</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">pixmap</span><span class="p">)</span>

        <span class="c1"># Beam 1 and Beam 2 models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaB1TableModel</span> <span class="o">=</span> <span class="n">ChromaticityTableModel</span><span class="p">(</span>
            <span class="n">chroma_tfs</span><span class="p">[</span><span class="n">chroma_tfs</span><span class="p">[</span><span class="s2">&quot;BEAM&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;BEAM&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromaB2TableModel</span> <span class="o">=</span> <span class="n">ChromaticityTableModel</span><span class="p">(</span>
            <span class="n">chroma_tfs</span><span class="p">[</span><span class="n">chroma_tfs</span><span class="p">[</span><span class="s2">&quot;BEAM&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;BEAM&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Set the model of the beam depending on the tab selected</span>
        <span class="n">current_beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beamChromaticityTabWidget</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># index starts at 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beamChromaticityTableView</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;chromaB</span><span class="si">{</span><span class="n">current_beam</span><span class="si">}</span><span class="s2">TableModel&quot;</span><span class="p">))</span>
        <span class="c1"># Hide the indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beamChromaticityTableView</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Select an item when clicking on a cell, not the row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beamChromaticityTableView</span><span class="o">.</span><span class="n">setSelectionBehavior</span><span class="p">(</span><span class="n">QTableView</span><span class="o">.</span><span class="n">SelectItems</span><span class="p">)</span>
        <span class="c1"># Take all the horizontal space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beamChromaticityTableView</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>

<div class="viewcode-block" id="MainWindow.updateChromaPlots">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.updateChromaPlots">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">updateChromaPlots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a plot to show the Chromaticity for both axes and both beams</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove the existing plots, if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1YWidget</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2XWidget</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2YWidget</span><span class="p">)</span>

        <span class="c1"># Create the Matplotlib widgets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1YWidget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2XWidget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2YWidget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>

        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1YWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2XWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2YWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># Add the widgets to the layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam1ChromaLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam1ChromaLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1YWidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam2ChromaLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2XWidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam2ChromaLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2YWidget</span><span class="p">)</span>

        <span class="c1"># General values</span>
        <span class="n">chroma_tfs_file</span> <span class="o">=</span> <span class="n">tfs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">CHROMA_FILE</span><span class="p">)</span>

        <span class="c1"># Filter the chromaticity orders in case more are checked than already measured</span>
        <span class="n">fit_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChromaticityOrders</span><span class="p">()</span>

        <span class="c1"># Beam 1</span>
        <span class="n">dpp_file_b1</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2scores</span><span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">][</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_chromaticity</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">dpp_file_b1</span><span class="p">,</span>
            <span class="n">chroma_tfs_file</span><span class="p">,</span>
            <span class="s2">&quot;X&quot;</span><span class="p">,</span>
            <span class="n">fit_orders</span><span class="p">,</span>
            <span class="s2">&quot;B1&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2scores</span><span class="p">[</span><span class="s2">&quot;B1&quot;</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_chromaticity</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1YWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1YWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">dpp_file_b1</span><span class="p">,</span>
            <span class="n">chroma_tfs_file</span><span class="p">,</span>
            <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
            <span class="n">fit_orders</span><span class="p">,</span>
            <span class="s2">&quot;B1&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Beam 2</span>
        <span class="n">dpp_file_b2</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">cleaning_constants</span><span class="o">.</span><span class="n">CLEANED_DPP_FILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2scores</span><span class="p">[</span><span class="s2">&quot;B2&quot;</span><span class="p">][</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_chromaticity</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2XWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2XWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">dpp_file_b2</span><span class="p">,</span>
            <span class="n">chroma_tfs_file</span><span class="p">,</span>
            <span class="s2">&quot;X&quot;</span><span class="p">,</span>
            <span class="n">fit_orders</span><span class="p">,</span>
            <span class="s2">&quot;B2&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2scores</span><span class="p">[</span><span class="s2">&quot;B2&quot;</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_chromaticity</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2YWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2YWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">dpp_file_b2</span><span class="p">,</span>
            <span class="n">chroma_tfs_file</span><span class="p">,</span>
            <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
            <span class="n">fit_orders</span><span class="p">,</span>
            <span class="s2">&quot;B2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set the r2 scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateR2scores</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">savePlotsClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">save_chromaticity_plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1XWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;Beam1_Qx&quot;</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">save_chromaticity_plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB1YWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;Beam1_Qy&quot;</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">save_chromaticity_plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2XWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;Beam2_Qx&quot;</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">save_chromaticity_plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotChromaB2YWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;Beam2_Qy&quot;</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved Chromaticity plots to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MainWindow.copyTableClicked">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.copyTableClicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copyTableClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies the displayed chromaticity table into the clipboard</span>
<span class="sd">        Two formattings can be used: markdown and latex.</span>
<span class="sd">        The latex version is a bit more refined, is uses the math modes to nicely display the header.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">format_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyTableComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="n">current_beam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beamChromaticityTabWidget</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># index starts at 0</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;chromaB</span><span class="si">{</span><span class="n">current_beam</span><span class="si">}</span><span class="s2">TableModel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getDataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">format_table</span> <span class="o">==</span> <span class="s2">&quot;Markdown&quot;</span><span class="p">:</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_markdown</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">format_table</span> <span class="o">==</span> <span class="s2">&quot;LaTeX&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">$&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_latex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;{(&quot;</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;)}&quot;</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;midrule&quot;</span><span class="p">,</span> <span class="s2">&quot;hline&quot;</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;toprule&quot;</span><span class="p">,</span> <span class="s2">&quot;hline&quot;</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;bottomrule&quot;</span><span class="p">,</span> <span class="s2">&quot;hline&quot;</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">textasciicircum &quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;x10^&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">times 10^{&quot;</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;}]&quot;</span><span class="p">)</span>
            <span class="n">df_text</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span>

        <span class="n">pyperclip</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">df_text</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chromaticity Table for beam </span><span class="si">{</span><span class="n">current_beam</span><span class="si">}</span><span class="s2"> copied to clipboard.&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">useRawBBQCheckBoxClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">raw_enabled</span> <span class="o">=</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">2</span>

        <span class="c1"># Turn ON or OFF some features depending on if the user wants to use the raw BBQ or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useNAFFCheckBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">raw_enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondsStep</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">raw_enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernelSize</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">raw_enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q1Quartile</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">raw_enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q3Quartile</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">raw_enabled</span><span class="p">)</span>

        <span class="c1"># Enable or disable functionalities depending on the selected method</span>
        <span class="k">if</span> <span class="n">raw_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">useNAFFCheckBoxClicked</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">useNAFFCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">)</span>  <span class="c1"># Send a 0 or 2 depending on the state</span>

<div class="viewcode-block" id="MainWindow.useNAFFCheckBoxClicked">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.useNAFFCheckBoxClicked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">useNAFFCheckBoxClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function called by the GUI when clicking the &quot;Use NAFF&quot; checkbox.</span>
<span class="sd">        This disables some functionalities only used for the raw bbq spectrogram</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Turn ON or OFF some raw bbq functions</span>
        <span class="n">naff_enabled</span> <span class="o">=</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernelSize</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">naff_enabled</span><span class="p">)</span></div>


<div class="viewcode-block" id="MainWindow.timberVariableSelectionChanged">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MainWindow.timberVariableSelectionChanged">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">timberVariableSelectionChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to be called when an element of the timber selection has been changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedTimberVariables</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectedTimberVariables</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not remove the selected timber variable &#39;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Checked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selectedTimberVariables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>

        <span class="c1"># Update the plot accordingly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateTimberPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">updateTimberTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="c1"># Get the available variables from the extracted data</span>
        <span class="n">available_variables</span> <span class="o">=</span> <span class="n">get_variables_names_from_csv</span><span class="p">(</span>
            <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">timber</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">FILENAME</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">available_variables</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">QListWidgetItem</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsUserCheckable</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timberVariablesListWidget</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">updateTimberPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="c1"># Remove the existing plot, if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletePlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span><span class="p">)</span>

        <span class="c1"># Create the Matplotlib widgets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span> <span class="o">=</span> <span class="n">MplWidget</span><span class="p">()</span>

        <span class="c1"># Add the widgets to the layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timberDataLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span><span class="p">)</span>

        <span class="n">plot_timber</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">measurement</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">timber</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selectedTimberVariables</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotTimberWidget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setChromaticityOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orders</span><span class="p">):</span>
        <span class="n">all_orders</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="o">.</span><span class="n">itemText</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">all_orders</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>
            <span class="n">dq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromaOrderComboBox</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
                <span class="n">dq</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Checked</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dq</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">openMeasurementCorrectionB1Clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;Select the Optics directory of the measurement to correct&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">measurements_path</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurementCorrectionB1LineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">openMeasurementCorrectionB2Clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;Select the Optics directory of the measurement to correct&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">measurements_path</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurementCorrectionB2LineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correctionButtonClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">optics_path_B1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurementCorrectionB1LineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="n">optics_path_B2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurementCorrectionB2LineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

        <span class="c1"># Name of the optics the response matrix was computed for</span>
        <span class="n">optics_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opticsComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>

        <span class="n">observables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observablesCorrectionComboBox</span><span class="o">.</span><span class="n">currentData</span><span class="p">()</span>
        <span class="n">chroma_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorChromaSpinBox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">rcond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcondCorrectionSpinBox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctionMethodComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="n">keep_dq3_constant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepDQ3ConstantcheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">keep_rdt_constant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepRDTConstantCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">clean_nan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanNaNCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">clean_outliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanOutliersCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">clean_IR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanIRSpinBox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No observables selected!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">optics_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">optics_path_B1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">optics_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">optics_path_B1</span>
        <span class="k">if</span> <span class="n">optics_path_B2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">optics_paths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">optics_path_B2</span>

        <span class="c1"># Check if we need the optics analysis or not</span>
        <span class="n">rdt_in_observables</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="s2">&quot;f&quot;</span> <span class="ow">in</span> <span class="n">obs</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">observables</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">optics_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rdt_in_observables</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No measurement path selected!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># The computations are too fast, add a cooldown so the user knobs it has computed</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">text_edit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;correction</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">TextEdit&quot;</span><span class="p">)</span>
            <span class="n">text_edit</span><span class="o">.</span><span class="n">setHtml</span><span class="p">(</span><span class="s2">&quot;Computing...&quot;</span><span class="p">)</span>
        <span class="n">QtTest</span><span class="o">.</span><span class="n">QTest</span><span class="o">.</span><span class="n">qWait</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Response Matrix creation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startThread</span><span class="p">(</span>
            <span class="s2">&quot;computeCorrections&quot;</span><span class="p">,</span>
            <span class="s2">&quot;correctionsFinished&quot;</span><span class="p">,</span>
            <span class="n">optics_paths</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="n">method</span><span class="p">,</span>
            <span class="n">observables</span><span class="p">,</span>
            <span class="n">chroma_factor</span><span class="p">,</span>
            <span class="n">rcond</span><span class="p">,</span>
            <span class="n">keep_dq3_constant</span><span class="p">,</span>
            <span class="n">keep_rdt_constant</span><span class="p">,</span>
            <span class="n">clean_nan</span><span class="p">,</span>
            <span class="n">clean_outliers</span><span class="p">,</span>
            <span class="n">clean_IR</span><span class="p">,</span>
            <span class="n">optics_name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correctionsFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;nbsp;&quot;</span><span class="p">)</span>
            <span class="n">text_edit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;correction</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">TextEdit&quot;</span><span class="p">)</span>
            <span class="n">text_edit</span><span class="o">.</span><span class="n">setHtml</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Corrections done!&quot;</span><span class="p">)</span>

    <span class="c1"># === Matplotlib rcParams</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rcParamsClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rcparams_dialog</span> <span class="o">=</span> <span class="n">MplRcParamsDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">rcparams_dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="MplRcParamsDialog">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MplRcParamsDialog">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MplRcParamsDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">,</span> <span class="n">rcparams_window_class</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">QDialog</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openRcParams</span><span class="p">()</span>

<div class="viewcode-block" id="MplRcParamsDialog.openRcParams">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MplRcParamsDialog.openRcParams">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">openRcParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens the user rcParams or the default one for the GUI</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">findMainWindow</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rcParams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">findMainWindow</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rcParams</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_rcparams</span> <span class="o">=</span> <span class="n">RESOURCES</span> <span class="o">/</span> <span class="s2">&quot;chroma_gui.mplstyle&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">original_rcparams</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rcParamsTextEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>


<div class="viewcode-block" id="MplRcParamsDialog.accept">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.MplRcParamsDialog.accept">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buttonClicked</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the rcParams to the resource folder.</span>
<span class="sd">        Can be triggered by clicking &quot;Save&quot; and &quot;Apply&quot;.</span>
<span class="sd">        &quot;Save&quot; closes the window after having saved the file.</span>
<span class="sd">        &quot;Apply&quot; can be used to keep it open while tinkering with graphs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rcParams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcParamsTextEdit</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rcParams</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The supplied rcParams are empty! The file will not be overwritten.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Set the field and then save it</span>
        <span class="n">findMainWindow</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rcParams</span> <span class="o">=</span> <span class="n">rcParams</span>
        <span class="n">findMainWindow</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">save_field</span><span class="p">(</span><span class="s2">&quot;rcParams&quot;</span><span class="p">,</span> <span class="n">rcParams</span><span class="p">)</span>

        <span class="c1"># Apply the new style</span>
        <span class="n">findMainWindow</span><span class="p">()</span><span class="o">.</span><span class="n">applyMplStyle</span><span class="p">()</span>

        <span class="n">clicked_role</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">buttonRole</span><span class="p">(</span><span class="n">buttonClicked</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clicked_role</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">AcceptRole</span><span class="p">:</span>  <span class="c1"># Close the dialog</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Matplotlib rcParams written&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="NewMeasurementDialog">
<a class="viewcode-back" href="../../main/chroma_gui.html#chroma_gui.main.NewMeasurementDialog">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NewMeasurementDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">,</span> <span class="n">new_measurement_class</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">QDialog</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">openLocationClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">main_window</span> <span class="o">=</span> <span class="n">findMainWindow</span><span class="p">()</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;Select new Measurement Directory&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">measurements_path</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locationLineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">openModelB1Clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openModel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modelB1LineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">openModelB2Clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openModel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modelB2LineEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">openModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">main_window</span> <span class="o">=</span> <span class="n">findMainWindow</span><span class="p">()</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;Select Model Directory&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_path</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">folder</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">createMeasurement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;B1&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelB1LineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">()),</span>
            <span class="s2">&quot;B2&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelB2LineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">()),</span>
        <span class="p">}</span>
        <span class="c1"># Set the start and end time of the timber extraction to the current date</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">measurement</span> <span class="o">=</span> <span class="n">Measurement</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locationLineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">()),</span>
            <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptionTextEdit</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">(),</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">end_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">measurement</span><span class="o">.</span><span class="n">save_as_json</span><span class="p">()</span>

        <span class="n">main_window</span> <span class="o">=</span> <span class="n">findMainWindow</span><span class="p">()</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="n">measurement</span>
        <span class="n">main_window</span><span class="o">.</span><span class="n">updateLineEdits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">findMainWindow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">QMainWindow</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="c1"># Global function to find the (open) QMainWindow in application</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">widget</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">topLevelWidgets</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">QMainWindow</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">widget</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running the chroma-gui with python: </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Setup an exception catcher so the app does not crash</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">exceptHook</span>

    <span class="c1"># Start the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">ChromaGui</span> <span class="o">=</span> <span class="n">MainWindow</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ChromaGui</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
</pre></div>

           </div>
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>